<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Demande de Messe - R√©daction d'Intention</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link rel="stylesheet" href="styles.css" />
    <style>
        /* Simple styles for the toggle switch */
        .toggle-switch {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }
    
        .switch {
            position: relative;
            display: inline-block;
            width: 46px;
            height: 26px;
            margin-bottom: 0;
        }
    
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
    
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: 0.2s;
            border-radius: 999px;
        }
    
        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.2s;
            border-radius: 50%;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }
    
        .switch input:checked+.slider {
            background-color: #22c55e;
            /* green when ON */
        }
    
        .switch input:checked+.slider:before {
            transform: translateX(20px);
        }
    
        .toggle-label {
            font-weight: 600;
            color: #1f2937;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>Quelle intention de pri√®re ?</h1>
            <div class="progress-bar">
                <div class="progress-step active">1</div>
                <div class="progress-step">2</div>
                <div class="progress-step">3</div>
                <div class="progress-step">4</div>
                <div class="progress-step">5</div>
            </div>
        </div>

        <div class="content">
            <div class="step active" id="step-category">
                <h2>Choisissez une cat√©gorie</h2>
                <p>Quelle cat√©gorie correspond le mieux √† votre intention ?</p>

                <div class="search-container">
                    <i class="fas fa-search search-icon"></i>
                    <input type="text" class="search-input" id="search-input"
                        placeholder="Rechercher une intention (d√©funt, sant√©, voyage...)">
                    <div class="search-results" id="search-results"></div>
                </div>

                <div class="quick-search-title">Ou parcourir par cat√©gorie</div>

                <div class="categories-grid">
                    <div class="category-card" data-category="defunt">
                        <div class="category-icon">‚õ™</div>
                        <div class="category-name">D√©funts</div>
                    </div>
                    <div class="category-card" data-category="sante">
                        <div class="category-icon">‚ù§Ô∏è</div>
                        <div class="category-name">Sant√©</div>
                    </div>
                    <div class="category-card" data-category="famille">
                        <div class="category-icon">üë®‚Äçüë©‚Äçüëß‚Äçüë¶</div>
                        <div class="category-name">Famille</div>
                    </div>
                    <div class="category-card" data-category="voyage">
                        <div class="category-icon">‚úàÔ∏è</div>
                        <div class="category-name">Voyage</div>
                    </div>
                    <div class="category-card" data-category="action-de-grace">
                        <div class="category-icon">üôè</div>
                        <div class="category-name">Action de gr√¢ce</div>
                    </div>
                    <div class="category-card" data-category="travail">
                        <div class="category-icon">üíº</div>
                        <div class="category-name">Travail</div>
                    </div>
                    <div class="category-card" data-category="reussite">
                        <div class="category-icon">üéì</div>
                        <div class="category-name">R√©ussite</div>
                    </div>
                    <div class="category-card" data-category="spiritualite">
                        <div class="category-icon">‚õ™</div>
                        <div class="category-name">Spiritualit√©</div>
                    </div>
                    <div class="category-card" data-category="monde">
                        <div class="category-icon">üåç</div>
                        <div class="category-name">Monde & Soci√©t√©</div>
                    </div>
                </div>
            </div>

            <div class="step" id="step-subcategory">
                <h2>Pr√©cisez votre intention</h2>
                <p>S√©lectionnez une sous-cat√©gorie pour affiner votre demande</p>

                <div class="selected-category">
                    <i class="fas fa-folder-open"></i>
                    <span id="selected-category-name">Cat√©gorie s√©lectionn√©e</span>
                </div>

                <div class="subcategories-grid" id="subcategories-container"></div>
            </div>

            <div class="step" id="step-redaction">
                <h2>R√©digez votre intention</h2>
                <p>Nous avons pr√©par√© une suggestion que vous pouvez personnaliser</p>

                <div class="selected-category">
                    <i class="fas fa-folder-open"></i>
                    <span id="final-category-name">Cat√©gorie > Sous-cat√©gorie</span>
                </div>

                <div class="input-section">
                    <!-- Accessible toggle switch: ON = Suggestion d'intention (default), OFF = R√©diger moi-m√™me -->
                    <div class="toggle-switch">
                        <label class="switch" aria-label="Mode de r√©daction">
                            <input type="checkbox" id="toggle-switch" checked>
                            <span class="slider"></span>
                        </label>
                        <span id="toggle-label" class="toggle-label">Suggestion d'intention (IA)</span>
                    </div>

                    <div id="ai-assist-section">
                        <div class="suggestion-box">
                            <div class="suggestion-header">
                                <div class="suggestion-title">Suggestion</div>
                                <button class="regenerate-btn">
                                    <i class="fas fa-rotate"></i> R√©g√©n√©rer
                                </button>
                            </div>
                            <div class="suggestion-text" id="suggestion-text">Veuillez s√©lectionner une sous-cat√©gorie pour g√©n√©rer une suggestion.
                            </div>
                        </div>
                    </div>

                    <div id="manual-input-section" style="display: none;">
                        <textarea placeholder="R√©digez votre intention de messe ici..." id="manual-textarea"></textarea>
                    </div>
                </div>
            </div>

            <div class="action-buttons">
                <button class="btn btn-secondary" id="btn-back-sticky" disabled>
                    <i class="fas fa-arrow-left"></i> Retour
                </button>
                <button class="btn btn-primary" id="btn-next-sticky" disabled>
                    Suivant <i class="fas fa-arrow-right"></i>
                </button>
            </div>
        </div>
    </div>

    <script src="script.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const steps = document.querySelectorAll('.step');
            const categoryCards = document.querySelectorAll('.category-card');
            const btnNextCategory = document.getElementById('btn-next-category');
            const btnNextSubcategory = document.getElementById('btn-next-subcategory');
            const btnBackCategory = document.getElementById('btn-back-category');
            const btnBackSubcategory = document.getElementById('btn-back-subcategory');
            const btnContinue = document.getElementById('btn-continue');
            const selectedCategoryName = document.getElementById('selected-category-name');
            const finalCategoryName = document.getElementById('final-category-name');
            const subcategoriesContainer = document.getElementById('subcategories-container');
            const toggleSwitch = document.getElementById('toggle-switch');
            const toggleLabel = document.getElementById('toggle-label');
            const aiAssistSection = document.getElementById('ai-assist-section');
            const manualInputSection = document.getElementById('manual-input-section');
            const regenerateButton = document.querySelector('.regenerate-btn');
            const suggestionText = document.getElementById('suggestion-text');
            const manualTextarea = document.getElementById('manual-textarea');
            const searchInput = document.getElementById('search-input');
            const searchResults = document.getElementById('search-results');
            const btnBackSticky = document.getElementById('btn-back-sticky');
            const btnNextSticky = document.getElementById('btn-next-sticky');

            let currentStep = 0;
            let selectedCategory = null;
            let selectedSubcategory = null;
            let toggle = null;

            function isAiMode () {
                return toggleSwitch ? toggleSwitch.checked : true;
            }

            function initApp () {
                setupEventListeners();

                // Initialize toggle from localStorage (default ON = AI suggestions)
                const savedToggle = localStorage.getItem("toggle");
                if (savedToggle === "manual") {
                    if (toggleSwitch) toggleSwitch.checked = false;
                } else {
                    if (toggleSwitch) toggleSwitch.checked = true;
                }

                // Trigger UI update according to toggle state BEFORE restoring steps
                if (toggleSwitch) {
                    toggleSwitch.dispatchEvent(new Event('change'));
                }

                showStep(0);

                const savedCategory = localStorage.getItem('selectedCategory');
                const savedSubcategory = localStorage.getItem('selectedSubcategory');
                const savedIntention = localStorage.getItem('intentionText');

                if (savedCategory) {
                    selectCategory(savedCategory);

                    if (savedSubcategory) {
                        selectedSubcategory = savedSubcategory;
                        finalCategoryName.textContent = `${categories[savedCategory].name} > ${categories[savedCategory].subcategories[savedSubcategory]}`;

                        // Restore saved intention into both suggestion and manual textarea
                        if (savedIntention) {
                            suggestionText.textContent = savedIntention;
                            // Only set manual textarea if user chose manual mode previously
                            if (savedToggle === 'manual') {
                                manualTextarea.value = savedIntention;
                            }
                        }

                        showStep(2);
                    } else {
                        showStep(1);
                    }
                }

                updateStickyButtons();
            }

            function setupEventListeners () {
                categoryCards.forEach(card => {
                    card.addEventListener('click', function () {
                        selectCategory(this.dataset.category);
                    });
                });

                // Toggle switch change handler
                if (toggleSwitch) {
                    toggleSwitch.addEventListener('change', function () {
                        if (this.checked) {
                            aiAssistSection.style.display = 'block';
                            manualInputSection.style.display = 'none';
                            localStorage.setItem('toggle', 'ai');
                        } else {
                            manualInputSection.style.display = 'block';
                            aiAssistSection.style.display = 'none';
                            localStorage.setItem('toggle', 'manual');
                        }

                        updateContinueButton();
                    });
                }

                regenerateButton.addEventListener('click', regenerateSuggestion);
                manualTextarea.addEventListener('input', updateContinueButton);
                manualTextarea.addEventListener('input', function () {
                    localStorage.setItem('intentionText', this.value);
                });
                searchInput.addEventListener('input', handleSearch);
                searchInput.addEventListener('focus', handleSearch);

                btnNextSticky.addEventListener('click', function () {
                    if (currentStep === 0) {
                        showStep(1);
                    } else if (currentStep === 1) {
                        showStep(2);
                    } else if (currentStep === 2) {
                        localStorage.setItem('intentionText', isAiMode() ? suggestionText.textContent : manualTextarea.value);
                        window.location.href = 'dates.html';
                    }
                });

                btnBackSticky.addEventListener('click', function () {
                    if (currentStep === 1) {
                        showStep(0);
                    } else if (currentStep === 2) {
                        showStep(1);
                    }
                });
            }

            function showStep (stepIndex) {
                steps.forEach(step => step.classList.remove('active'));
                steps[stepIndex].classList.add('active');
                currentStep = stepIndex;

                if (stepIndex === 1 && selectedCategory) {
                    displaySubcategories();
                } else if (stepIndex === 2 && selectedSubcategory && isAiMode()) {
                    generateSuggestion();
                }

                updateStickyButtons();
            }

            function selectCategory (categoryId) {
                categoryCards.forEach(card => card.classList.remove('selected'));
                const selectedCard = document.querySelector(`.category-card[data-category="${categoryId}"]`);
                selectedCard.classList.add('selected');

                selectedCategory = categoryId;
                selectedCategoryName.textContent = categories[categoryId].name;
                finalCategoryName.textContent = `${categories[categoryId].name} > `;

                localStorage.setItem('selectedCategory', categoryId);
                btnNextSticky.disabled = false;
            }

            function displaySubcategories () {
                subcategoriesContainer.innerHTML = '';

                for (const [id, name] of Object.entries(categories[selectedCategory].subcategories)) {
                    const subcategoryCard = document.createElement('div');
                    subcategoryCard.className = 'subcategory-card';
                    subcategoryCard.dataset.subcategory = id;

                    subcategoryCard.innerHTML = `
                        <div class="subcategory-icon">${categories[selectedCategory].icon}</div>
                        <div class="subcategory-name">${name}</div>
                    `;

                    subcategoryCard.addEventListener('click', function () {
                        selectSubcategory(this.dataset.subcategory);
                    });

                    subcategoriesContainer.appendChild(subcategoryCard);
                }

                if (selectedSubcategory) {
                    // Si une sous-cat√©gorie est d√©j√† s√©lectionn√©e, la s√©lectionner √† nouveau
                    selectSubcategory(selectedSubcategory);
                }
            }

            function selectSubcategory (subcategoryId) {
                const subcategoryCards = document.querySelectorAll('.subcategory-card');
                subcategoryCards.forEach(card => card.classList.remove('selected'));

                const selectedCard = document.querySelector(`.subcategory-card[data-subcategory="${subcategoryId}"]`);

                if (selectedCard) {
                    selectedCard.classList.add("selected");
                }

                selectedSubcategory = subcategoryId;
                finalCategoryName.textContent = `${categories[selectedCategory].name} > ${categories[selectedCategory].subcategories[subcategoryId]}`;

                localStorage.setItem('selectedSubcategory', subcategoryId);
                btnNextSticky.disabled = false;
            }

            function generateSuggestion () {
                if (selectedSubcategory && suggestions[selectedSubcategory]) {
                    suggestionText.textContent = suggestions[selectedSubcategory];
                } else {
                    suggestionText.textContent = "Pour l'intention de [pr√©cisez], que Dieu accorde ses gr√¢ces selon sa volont√© divine.";
                }

                // Only overwrite manual textarea when in AI mode; do not clobber user-written manual text
                if (isAiMode()) {
                    manualTextarea.value = suggestionText.textContent;
                }
                
                updateContinueButton();
            }

            function regenerateSuggestion () {
                if (selectedSubcategory) {
                    suggestionText.textContent = "G√©n√©ration en cours...";

                    setTimeout(() => {
                        generateSuggestion();
                    }, 500);
                }
            }

            function updateContinueButton () {
                btnNextSticky.disabled = !(currentStep === 2 ? (isAiMode() ? selectedSubcategory : manualTextarea.value.trim()) : true);
            }

            function updateStickyButtons () {
                btnBackSticky.disabled = currentStep === 0;
                btnBackSticky.style.visibility = currentStep === 0 ? 'hidden' : 'visible';

                if (currentStep === 0) {
                    btnNextSticky.disabled = !selectedCategory;
                } else if (currentStep === 1) {
                    btnNextSticky.disabled = !selectedSubcategory;
                } else if (currentStep === 2) {
                    updateContinueButton();
                }
            }

            function handleSearch () {
                const query = searchInput.value.toLowerCase().trim();

                if (query.length < 2) {
                    searchResults.style.display = 'none';
                    return;
                }

                const results = searchIndex.filter(item =>
                    item.name.toLowerCase().includes(query) ||
                    item.categoryName.toLowerCase().includes(query)
                );

                displaySearchResults(results);
            }

            function displaySearchResults (results) {
                searchResults.innerHTML = '';

                if (results.length === 0) {
                    const noResult = document.createElement('div');
                    noResult.className = 'search-result-item';
                    noResult.textContent = 'Aucun r√©sultat trouv√©';
                    searchResults.appendChild(noResult);
                } else {
                    results.forEach(result => {
                        const resultItem = document.createElement('div');
                        resultItem.className = 'search-result-item';
                        resultItem.innerHTML = `
                            <div>${result.icon}</div>
                            <div>${result.name}</div>
                            <div class="search-result-category">${result.categoryName}</div>
                        `;

                        resultItem.addEventListener('click', () => {
                            selectedCategory = result.categoryId;
                            selectedSubcategory = result.id;
                            finalCategoryName.textContent = `${result.categoryName} > ${result.name}`;

                            localStorage.setItem('selectedCategory', result.categoryId);
                            localStorage.setItem('selectedSubcategory', result.id);

                            generateSuggestion();
                            showStep(2);

                            searchResults.style.display = 'none';
                            searchInput.value = '';
                        });

                        searchResults.appendChild(resultItem);
                    });
                }

                searchResults.style.display = 'block';
            }

            initApp();
        });
    </script>
</body>

</html>